<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!--
        Render a res.partner record to be added to the UBL xml document.
        -->
        <template id="export_invoice_ubl_2_0_partner">
            <cac:Party
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:WebsiteURI t-esc="WebsiteURI"/>
                <t id="PartyName_list" t-foreach="vals['PartyName_list']" t-as="PartyName">
                    <cac:PartyName>
                        <cbc:Name t-esc="PartyName['Name']"/>
                    </cac:PartyName>
                </t>
                <cac:Language t-if="vals['Language']">
                    <cbc:LocaleCode t-esc="vals['Language']['LocaleCode']"/>
                </cac:Language>
                <cac:PostalAddress>
                    <cbc:StreetName t-esc="vals['PostalAddress']['StreetName']"/>
                    <cbc:AdditionalStreetName t-esc="vals['PostalAddress']['AdditionalStreetName']"/>
                    <cbc:CityName t-esc="vals['PostalAddress']['CityName']"/>
                    <cbc:PostalZone t-esc="vals['PostalAddress']['PostalZone']"/>
                    <cbc:CountrySubentity t-esc="vals['PostalAddress']['CountrySubentity']"/>
                    <cbc:CountrySubentityCode t-esc="vals['PostalAddress']['CountrySubentityCode']"/>
                    <cac:Country t-if="vals['PostalAddress']['Country']">
                        <cbc:IdentificationCode t-esc="vals['PostalAddress']['Country']['IdentificationCode']"/>
                        <cbc:Name t-esc="vals['PostalAddress']['Country']['Name']"/>
                    </cac:Country>
                </cac:PostalAddress>
                <t id="PartyTaxScheme_list" t-foreach="vals['PartyTaxScheme_list']" t-as="PartyTaxScheme">
                    <cac:PartyTaxScheme>
                        <cbc:RegistrationName t-esc="PartyTaxScheme['RegistrationName']"/>
                        <cbc:CompanyID t-esc="PartyTaxScheme['CompanyID']"/>
                        <cac:TaxScheme>
                            <cbc:ID
                                schemeID="UN/ECE 5153"
                                schemeAgencyID="6"
                                >VAT</cbc:ID>
                        </cac:TaxScheme>
                    </cac:PartyTaxScheme>
                </t>
                <cac:Contact>
                    <cbc:Name t-esc="vals['Contact']['Name']"/>
                    <cbc:Telephone t-esc="vals['Contact']['Telephone']"/>
                    <cbc:ElectronicMail t-esc="vals['Contact']['ElectronicMail']"/>
                </cac:Contact>
            </cac:Party>
        </template>

        <template id="export_invoice_ubl_2_0_taxes">
            <t xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
               xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
               xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <t id="TaxTotal_list" t-foreach="TaxTotal_list" t-as="TaxTotal">
                    <cac:TaxTotal>
                        <cbc:TaxAmount
                            t-att-currencyID="DocumentCurrencyCode"
                            t-esc="format_monetary(TaxTotal['TaxAmount'])"/>
                        <t id="TaxSubtotal_list" t-foreach="TaxTotal['TaxSubtotal_list']" t-as="TaxSubtotal">
                            <cbc:TaxSubtotal>
                                <cbc:TaxableAmount
                                    t-att-currencyID="DocumentCurrencyCode"
                                    t-esc="format_monetary(TaxSubtotal['TaxableAmount'])"/>
                                <cbc:TaxAmount
                                    t-att-currencyID="DocumentCurrencyCode"
                                    t-esc="format_monetary(TaxSubtotal['TaxAmount'])"/>
                                <cbc:Percent t-esc="TaxSubtotal['Percent']"/>
                            </cbc:TaxSubtotal>
                        </t>
                    </cac:TaxTotal>
                </t>
            </t>
        </template>

        <!--
        Render an invoice to be added to the UBL xml document.
        -->
        <template id="export_invoice_ubl_2_0">
            <Invoice
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                <cbc:UBLVersionID t-esc="UBLVersionID"/>
                <cbc:CustomizationID t-esc="CustomizationID"/>
                <cbc:ProfileID t-esc="ProfileID"/>
                <cbc:ID t-esc="ID"/>
                <cbc:IssueDate t-esc="IssueDate"/>
                <cbc:InvoiceTypeCode t-esc="InvoiceTypeCode"/>
                <t id="Note_list" t-foreach="Note_list" t-as="Note">
                    <cbc:Note t-esc="Note"/>
                </t>
                <cbc:DocumentCurrencyCode t-esc="DocumentCurrencyCode"/>
                <cbc:TaxCurrencyCode t-esc="TaxCurrencyCode"/>
                <cbc:LineCountNumeric t-esc="LineCountNumeric"/>
                <cac:OrderReference t-if="OrderReference">
                    <cbc:ID t-esc="OrderReference['ID']"/>
                </cac:OrderReference>
                <cac:AccountingSupplierParty t-call="{{template_partner}}">
                    <t t-set="vals" t-value="AccountingSupplierParty"/>
                </cac:AccountingSupplierParty>
                <cac:AccountingCustomerParty t-call="{{template_partner}}">
                    <t t-set="vals" t-value="AccountingCustomerParty"/>
                </cac:AccountingCustomerParty>
                <t id="PaymentMeans_list" t-foreach="PaymentMeans_list" t-as="PaymentMeans">
                    <cac:PaymentMeans>
                        <cbc:PaymentMeansCode listID="UN/ECE 4461" t-esc="PaymentMeans['PaymentMeansCode']"/>
                        <cbc:InstructionID t-esc="PaymentMeans['PaymentReference']"/>
                        <cbc:PaymentDueDate t-esc="PaymentMeans['PaymentDueDate']"/>
                        <cac:PayeeFinancialAccount t-if="PaymentMeans['PayeeFinancialAccount']">
                            <cbc:ID schemeName="IBAN" t-esc="PaymentMeans['PayeeFinancialAccount']['ID']"/>
                            <cac:FinancialInstitutionBranch
                                    t-if="PaymentMeans['PayeeFinancialAccount']['FinancialInstitutionBranch']">
                                <cac:FinancialInstitution>
                                    <cbc:ID schemeName="BIC"
                                            t-esc="PaymentMeans['PayeeFinancialAccount']['FinancialInstitutionBranch']['ID']"/>
                                </cac:FinancialInstitution>
                            </cac:FinancialInstitutionBranch>
                        </cac:PayeeFinancialAccount>
                    </cac:PaymentMeans>
                </t>
                <t id="PaymentTerms_list" t-foreach="PaymentTerms_list" t-as="PaymentTerms">
                    <cac:PaymentTerms>
                        <t id="Note_list" t-foreach="Note_list" t-as="Note">
                            <cbc:Note t-esc="Note['Note']"/>
                        </t>
                    </cac:PaymentTerms>
                </t>
                <t t-call="{{template_taxes}}"/>
                <cac:LegalMonetaryTotal>
                    <cbc:LineExtensionAmount
                        t-att-currencyID="DocumentCurrencyCode"
                        t-esc="format_monetary(LegalMonetaryTotal['LineExtensionAmount'])"/>
                    <cbc:TaxExclusiveAmount
                        t-att-currencyID="DocumentCurrencyCode"
                        t-esc="format_monetary(LegalMonetaryTotal['TaxExclusiveAmount'])"/>
                    <cbc:TaxInclusiveAmount
                        t-att-currencyID="DocumentCurrencyCode"
                        t-esc="format_monetary(LegalMonetaryTotal['TaxInclusiveAmount'])"/>
                    <cbc:PrepaidAmount
                        t-att-currencyID="DocumentCurrencyCode"
                        t-esc="format_monetary(LegalMonetaryTotal['PrepaidAmount'])"/>
                    <cbc:PayableAmount
                        t-att-currencyID="DocumentCurrencyCode"
                        t-esc="format_monetary(LegalMonetaryTotal['PayableAmount'])"/>
                </cac:LegalMonetaryTotal>
                <t id="InvoiceLine_list" t-foreach="InvoiceLine_list" t-as="InvoiceLine">
                    <cac:InvoiceLine>
                        <cbc:ID t-esc="InvoiceLine['ID']"/>
                        <cbc:Note t-esc="InvoiceLine['Note']"/>
                        <cbc:InvoicedQuantity t-esc="InvoiceLine['InvoicedQuantity']"/>
                        <cbc:LineExtensionAmount
                            t-att-currencyID="DocumentCurrencyCode"
                            t-esc="format_monetary(InvoiceLine['LineExtensionAmount'])"/>
                        <t t-call="{{template_taxes}}">
                            <t t-set="TaxTotal_list" t-value="InvoiceLine['TaxTotal_list']"/>
                        </t>
                        <cac:Item>
                            <cbc:Description t-esc="InvoiceLine['Item']['Description']"/>
                            <cbc:Name t-esc="InvoiceLine['Item']['Name']"/>
                            <cac:SellersItemIdentification t-if="InvoiceLine['Item']['SellersItemIdentification']">
                                <cbc:ID t-esc="InvoiceLine['Item']['SellersItemIdentification']['ID']"/>
                            </cac:SellersItemIdentification>
                        </cac:Item>
                        <cac:Price>
                            <cbc:PriceAmount
                                t-att-currencyID="DocumentCurrencyCode"
                                t-esc="format_monetary(InvoiceLine['Price']['PriceAmount'])"/>
                        </cac:Price>
                    </cac:InvoiceLine>
                </t>
            </Invoice>
        </template>

        <template id="export_invoice_ubl_2_1"
                  inherit_id="account_edi_ubl.export_invoice_ubl_2_0"
                  primary="True">
            <xpath xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                   expr="//*[local-name()='LineCountNumeric']"
                   position="after">
                <cbc:BuyerReference t-esc="BuyerReference"/>
            </xpath>
        </template>

    </data>
</odoo>
